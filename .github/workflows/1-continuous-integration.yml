name: 1 - Continuous Integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      trigger_reason:
        description: 'Reason for retraining'
        required: false
        default: 'manual'
        type: string

env:
  DOCKER_REGISTRY: ghcr.io
  GITHUB_ACTOR: ${{ github.actor }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      mlflow: ${{ steps.filter.outputs.mlflow }}
      training: ${{ steps.filter.outputs.training }}
      inference: ${{ steps.filter.outputs.inference }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.event_name == 'workflow_dispatch' && 'HEAD~1' || '' }}
          filters: |
            mlflow:
              - 'src/mlflow-server/**'
              - 'mlflow.compose.v1.yml'
            training:
              - 'src/training_api/**'
              - 'training.compose.v1.yml'
            inference:
              - 'src/inference_api/**'
              - 'inference.compose.v1.yml'

  unit-test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run pytest
        run: uv run pytest

  build-mlflow-container:
    if: needs.check-changes.outputs.mlflow == 'true'
    name: Build MLFlow Docker Container
    runs-on: ubuntu-latest
    needs: [unit-test, check-changes]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v5

      - name: Set lowercase image name
        id: image-name
        run: echo "IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/mlflow-server/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ steps.image-name.outputs.IMAGE_NAME }}-mlflow-server:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ steps.image-name.outputs.IMAGE_NAME }}-mlflow-server:latest

  deploy-mlflow-container:
    runs-on: self-hosted
    needs: build-mlflow-container
    steps:
      - uses: actions/checkout@v5

      - name: Set lowercase image name
        id: image-name
        run: echo "IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and Deploy MLFlow
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          export IMAGE_TAG=${{ github.sha }}
          cp -f mlflow.compose.v1.yml ~/mlflow.compose.v1.yml
          cd ~
          docker compose -f mlflow.compose.v1.yml pull
          docker rm -f mlflow || true
          docker compose -f mlflow.compose.v1.yml down || true
          docker compose -f mlflow.compose.v1.yml up -d

  build-training-api-container:
    if: needs.check-changes.outputs.training == 'true'
    name: Build Training API Docker Container
    runs-on: ubuntu-latest
    needs: [unit-test, check-changes]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v5

      - name: Set lowercase image name
        id: image-name
        run: echo "IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/training_api/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ steps.image-name.outputs.IMAGE_NAME }}-training:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ steps.image-name.outputs.IMAGE_NAME }}-training:latest

  build-inference-api-container:
    if: needs.check-changes.outputs.inference == 'true'
    name: Build Inference API Docker Container
    runs-on: ubuntu-latest
    needs: [unit-test, check-changes]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v5

      - name: Set lowercase image name
        id: image-name
        run: echo "IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/inference_api/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ steps.image-name.outputs.IMAGE_NAME }}-inference-api:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ steps.image-name.outputs.IMAGE_NAME }}-inference-api:latest

  deploy-inference-api-container:
    runs-on: inference
    needs: build-inference-api-container
    steps:
      - uses: actions/checkout@v5

      - name: Set lowercase image name
        id: image-name
        run: echo "IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and Deploy Inference API
        env:
          IMAGE_TAG: ${{ github.sha }}
          MLFLOW_MODEL_NAME: ${{ secrets.MODEL_NAME }}
          MLFLOW_MODEL_ALIAS: ${{ secrets.MODEL_ALIAS }}
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI_EXTERNAL }}
          MODEL_RETRAINING_TOKEN: ${{ secrets.MODEL_RETRAINING_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          export IMAGE_TAG=${{ github.sha }}
          export MODEL_RETRAINING_TOKEN=${{ secrets.MODEL_RETRAINING_TOKEN }}
          export GITHUB_REPOSITORY=${{ github.repository }}
          
          cp -f inference.compose.v1.yml ~/inference.compose.v1.yml
          cd ~
          docker compose -f inference.compose.v1.yml pull
          docker rm -f inference-api || true
          docker compose -f inference.compose.v1.yml down || true
          docker compose -f inference.compose.v1.yml up -d