name: 1 - Continuous Integration

on:
  push:
    branches: [ "*" ] # TODO later change to main, this is for testing
  pull_request:
    branches: [ "*" ] # TODO later change to main, this is for testing
  workflow_dispatch:

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      mlflow: ${{ steps.filter.outputs.mlflow }}
      training: ${{ steps.filter.outputs.training }}
      inference: ${{ steps.filter.outputs.inference }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            mlflow:
              - 'src/mlflow-server/**'
              - 'mlflow.compose.v1.yml'
            training:
              - 'src/training_api/**'
              - 'training.compose.v1.yml'
            inference:
              - 'src/inference_api/**'
              - 'inference.compose.v1.yml'

  unit-test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run pytest
        run: uv run pytest

  build-mlflow-container:
    if: needs.check-changes.outputs.mlflow == 'true'
    name: Build MLFlow Docker Container
    runs-on: ubuntu-latest
    needs: [unit-test, check-changes]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v5

      - name: Set lowercase image name
        id: image-name
        run: echo "IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/mlflow-server/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/${{ steps.image-name.outputs.IMAGE_NAME }}-mlflow-server:${{ github.sha }}

  build-training-api-container:
    if: needs.check-changes.outputs.training == 'true'
    name: Build Training API Docker Container
    runs-on: ubuntu-latest
    needs: [unit-test, check-changes]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v5

      - name: Set lowercase image name
        id: image-name
        run: echo "IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/training_api/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/${{ steps.image-name.outputs.IMAGE_NAME }}-training:${{ github.sha }}

  build-inference-api-container:
    if: needs.check-changes.outputs.inference == 'true'
    name: Build Inference API Docker Container
    runs-on: ubuntu-latest
    needs: [unit-test, check-changes]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v5

      - name: Set lowercase image name
        id: image-name
        run: echo "IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/inference_api/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/${{ steps.image-name.outputs.IMAGE_NAME }}-inference-api:${{ github.sha }}